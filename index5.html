<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinançasPro | Gerenciador Financeiro Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #ff9e00;
            --info-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: var(--dark-color);
            padding-bottom: 70px; /* Espaço para a barra de navegação fixa no rodapé */
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .balance-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .balance-card h2 {
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
        }
        
        .income-icon {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
        }
        
        .expense-icon {
            background-color: rgba(247, 37, 133, 0.2);
            color: var(--danger-color);
        }
        
        .transaction-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            transition: var(--transition);
        }
        
        .transaction-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .transaction-income .amount {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .transaction-expense .amount {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .progress-bar-custom {
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .btn-add {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.4);
            z-index: 1000;
            transition: var(--transition);
        }
        
        .btn-add:hover {
            background-color: var(--secondary-color);
            transform: scale(1.1);
            color: white;
        }
        
        /* Centralizar todos os modais */
        .modal-dialog-centered-custom {
            display: flex;
            align-items: center;
            min-height: calc(100% - 1rem);
        }
        
        .modal-dialog-centered-custom .modal-content {
            margin: auto;
        }
        
        .modal-content {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: var(--gray-color);
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: transparent;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-card .stat-label {
            color: var(--gray-color);
            font-size: 0.9rem;
        }
        
        .budget-progress {
            margin-top: 10px;
        }
        
        .filter-badge {
            cursor: pointer;
            transition: var(--transition);
        }
        
        .filter-badge:hover {
            opacity: 0.8;
        }
        
        .btn-action {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .btn-action:hover {
            transform: scale(1.1);
        }
        
        .category-badge {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .recurring-badge {
            background-color: rgba(114, 9, 183, 0.1);
            color: var(--info-color);
            font-size: 0.75rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* Controle de navegação de mês */
        .month-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .month-navigation-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 1px solid #dee2e6;
            color: var(--primary-color);
            transition: var(--transition);
        }
        
        .month-navigation-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .month-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
            min-width: 200px;
            text-align: center;
        }
        
        .current-month-badge {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        /* Barra de navegação fixa no rodapé */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 10px 0;
        }
        
        .nav-item {
            text-align: center;
            flex: 1;
        }
        
        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray-color);
            text-decoration: none;
            font-size: 0.8rem;
            transition: var(--transition);
        }
        
        .nav-link i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        .nav-link.active {
            color: var(--primary-color);
        }
        
        .nav-link:hover {
            color: var(--primary-color);
        }
        
        /* Cabeçalho fixo no topo */
        .app-header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .app-title {
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        /* Indicador de carregamento */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para status de efetivação */
        .status-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-completed {
            background-color: rgba(76, 201, 240, 0.15);
            color: var(--success-color);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .status-pending {
            background-color: rgba(255, 158, 0, 0.15);
            color: var(--warning-color);
            border: 1px solid rgba(255, 158, 0, 0.3);
        }
        
        .transaction-item.completed {
            opacity: 0.7;
            background-color: rgba(76, 201, 240, 0.05);
        }
        
        .transaction-item.pending {
            border-left: 3px solid var(--warning-color);
        }
        
        .status-toggle {
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.1rem;
        }
        
        .status-toggle:hover {
            transform: scale(1.2);
        }
        
        .status-toggle.completed {
            color: var(--success-color);
        }
        
        .status-toggle.pending {
            color: var(--warning-color);
        }
        
        .status-filter {
            margin-bottom: 15px;
        }
        
        .status-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: var(--border-radius);
        }
        
        .status-summary-item {
            text-align: center;
            flex: 1;
        }
        
        .status-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .status-summary-label {
            font-size: 0.85rem;
            color: var(--gray-color);
        }
        
        @media (max-width: 768px) {
            .balance-card h2 {
                font-size: 2rem;
            }
            
            .dashboard-card {
                padding: 15px;
            }
            
            .btn-add {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
                bottom: 70px;
                right: 15px;
            }
            
            .app-title {
                font-size: 1.5rem;
            }
            
            .nav-link {
                font-size: 0.7rem;
            }
            
            .nav-link i {
                font-size: 1rem;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .month-display {
                min-width: 150px;
                font-size: 1rem;
            }
            
            .month-navigation {
                gap: 10px;
            }
            
            .status-summary {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Cabeçalho Fixo -->
    <div class="app-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-8">
                    <h1 class="app-title">
                        <i class="bi bi-wallet2"></i>FinançasPro
                    </h1>
                </div>
                <div class="col-4 user-menu">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Configurações</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i>Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container app-container mt-4">
        <!-- Dashboard Principal -->
        <div id="dashboard">
            <!-- Navegação de Mês -->
            <div class="dashboard-card mb-4">
                <div class="month-navigation">
                    <button class="month-navigation-btn" id="prev-month-btn" title="Mês anterior">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="month-display" id="current-month-display">
                        Carregando...
                    </div>
                    <button class="month-navigation-btn" id="next-month-btn" title="Próximo mês">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div class="text-center d-none">
                    <button class="btn btn-sm btn-outline-primary" id="go-to-current-month">
                        <i class="bi bi-calendar-check me-1"></i>Voltar para mês atual
                    </button>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="dashboard-card balance-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-1">Saldo Total</p>
                                <h2 id="total-balance">R$ 0,00</h2>
                                <p class="mb-0" id="monthly-balance-change">
                                    <i class="bi bi-dash-circle me-1"></i> Carregando...
                                </p>
                            </div>
                            <div class="text-end">
                                <p class="mb-1">Receitas do mês</p>
                                <h4 id="monthly-income">R$ 0,00</h4>
                                <p class="mb-1">Despesas do mês</p>
                                <h4 id="monthly-expense">R$ 0,00</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="dashboard-card">
                        <h5 class="mb-3">Meta Mensal</h5>
                        <div class="mb-3">
                            <p class="mb-1">Economia: <strong id="savings-progress">R$ 0,00 / R$ 0,00</strong></p>
                            <div class="progress progress-bar-custom">
                                <div class="progress-bar bg-success" id="savings-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <p class="mb-1">Gasto com alimentação: <strong id="food-progress">R$ 0,00 / R$ 0,00</strong></p>
                            <div class="progress progress-bar-custom">
                                <div class="progress-bar bg-warning" id="food-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="dashboard-card stat-card">
                        <div class="stat-value" id="stat-income">R$ 0</div>
                        <div class="stat-label">Receitas</div>
                        <div class="mt-2"><i class="bi bi-arrow-up-circle text-success fs-4"></i></div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="dashboard-card stat-card">
                        <div class="stat-value" id="stat-expense">R$ 0</div>
                        <div class="stat-label">Despesas</div>
                        <div class="mt-2"><i class="bi bi-arrow-down-circle text-danger fs-4"></i></div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="dashboard-card stat-card">
                        <div class="stat-value" id="stat-savings">R$ 0</div>
                        <div class="stat-label">Economias</div>
                        <div class="mt-2"><i class="bi bi-piggy-bank text-primary fs-4"></i></div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="dashboard-card stat-card">
                        <div class="stat-value" id="transaction-count">0</div>
                        <div class="stat-label">Transações</div>
                        <div class="mt-2"><i class="bi bi-receipt text-warning fs-4"></i></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Transações do Mês</h5>
                            <div>
                                <span class="badge bg-light text-dark filter-badge me-2" data-filter="all">Todas</span>
                                <span class="badge bg-success filter-badge me-2" data-filter="income">Receitas</span>
                                <span class="badge bg-danger filter-badge" data-filter="expense">Despesas</span>
                            </div>
                        </div>
                        
                        <div id="transactions-list">
                            <div class="empty-state">
                                <div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                                <p class="mt-2">Carregando transações...</p>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary btn-sm" id="view-all-transactions">
                                Ver todas as transações
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="dashboard-card mb-4">
                        <h5 class="mb-3">Categorias de Despesas</h5>
                        <div id="expense-categories">
                            <div class="empty-state">
                                <div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                                <p class="mt-2">Carregando categorias...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h5 class="mb-3">Próximas Contas</h5>
                        <div id="upcoming-bills">
                            <div class="empty-state">
                                <div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                                <p class="mt-2">Carregando contas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção de Transações -->
        <div id="transactions" class="d-none">
            <!-- Navegação de Mês -->
            <div class="dashboard-card mb-4">
                <div class="month-navigation">
                    <button class="month-navigation-btn" id="prev-month-btn-transactions" title="Mês anterior">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="month-display" id="current-month-display-transactions">
                        Carregando...
                    </div>
                    <button class="month-navigation-btn" id="next-month-btn-transactions" title="Próximo mês">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div class="text-center">
                    <button class="btn btn-sm btn-outline-primary" id="go-to-current-month-transactions">
                        <i class="bi bi-calendar-check me-1"></i>Voltar para mês atual
                    </button>
                </div>
            </div>
            
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Transações do Mês</h4>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                        <i class="bi bi-plus-lg me-1"></i>Nova Transação
                    </button>
                </div>
                
                <!-- Resumo de Status -->
                <div class="status-summary mb-4">
                    <div class="status-summary-item">
                        <div class="status-summary-value text-success" id="completed-count">0</div>
                        <div class="status-summary-label">Efetivadas</div>
                    </div>
                    <div class="status-summary-item">
                        <div class="status-summary-value text-warning" id="pending-count">0</div>
                        <div class="status-summary-label">Pendentes</div>
                    </div>
                    <div class="status-summary-item">
                        <div class="status-summary-value text-primary" id="total-count">0</div>
                        <div class="status-summary-label">Total</div>
                    </div>
                    <div class="status-summary-item">
                        <div class="status-summary-value" id="completion-rate">0%</div>
                        <div class="status-summary-label">Taxa de Conclusão</div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" placeholder="Buscar transação..." id="search-transaction">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-filter"></i></span>
                            <select class="form-select" id="filter-category">
                                <option value="">Todas as categorias</option>
                                <!-- Categorias serão carregadas dinamicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                            <select class="form-select" id="filter-month">
                                <option value="all">Todos os meses</option>
                                <option value="0">Janeiro</option>
                                <option value="1">Fevereiro</option>
                                <option value="2">Março</option>
                                <option value="3">Abril</option>
                                <option value="4">Maio</option>
                                <option value="5">Junho</option>
                                <option value="6">Julho</option>
                                <option value="7">Agosto</option>
                                <option value="8">Setembro</option>
                                <option value="9">Outubro</option>
                                <option value="10">Novembro</option>
                                <option value="11">Dezembro</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-check-circle"></i></span>
                            <select class="form-select" id="filter-status">
                                <option value="all">Todos os status</option>
                                <option value="completed">Efetivadas</option>
                                <option value="pending">Pendentes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="all-transactions-list">
                    <div class="empty-state">
                        <div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                        <p class="mt-2">Carregando transações...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Seção de Orçamento -->
        <div id="budget" class="d-none">
            <!-- Navegação de Mês -->
            <div class="dashboard-card mb-4">
                <div class="month-navigation">
                    <button class="month-navigation-btn" id="prev-month-btn-budget" title="Mês anterior">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="month-display" id="current-month-display-budget">
                        Carregando...
                    </div>
                    <button class="month-navigation-btn" id="next-month-btn-budget" title="Próximo mês">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div class="text-center">
                    <button class="btn btn-sm btn-outline-primary" id="go-to-current-month-budget">
                        <i class="bi bi-calendar-check me-1"></i>Voltar para mês atual
                    </button>
                </div>
            </div>
            
            <div class="dashboard-card">
                <h4 class="mb-4">Meu Orçamento</h4>
                
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h5>Orçamento por Categoria</h5>
                        <div id="budget-categories">
                            <div class="empty-state">
                                <div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                                <p class="mt-2">Carregando orçamentos...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card">
                            <h5 class="mb-3">Definir Orçamento</h5>
                            <form id="budget-form">
                                <div class="mb-3">
                                    <label for="budget-category" class="form-label">Categoria</label>
                                    <select class="form-select" id="budget-category" required>
                                        <option value="">Selecione uma categoria</option>
                                        <!-- Categorias serão carregadas dinamicamente -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="budget-amount" class="form-label">Valor do Orçamento (R$)</label>
                                    <input type="number" class="form-control" id="budget-amount" required min="1" step="0.01">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Salvar Orçamento</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Seção de Categorias -->
        <div id="categories" class="d-none">
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4>Gerenciar Categorias</h4>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                        <i class="bi bi-plus-lg me-1"></i>Nova Categoria
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Categorias de Receitas</h5>
                        <div id="income-categories-list" class="mb-4">
                            <div class="empty-state">
                                <div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                                <p class="mt-2">Carregando categorias...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Categorias de Despesas</h5>
                        <div id="expense-categories-list" class="mb-4">
                            <div class="empty-state">
                                <div class="spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                                <p class="mt-2">Carregando categorias...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Seção de Relatórios -->
        <div id="reports" class="d-none">
            <!-- Navegação de Mês -->
            <div class="dashboard-card mb-4">
                <div class="month-navigation">
                    <button class="month-navigation-btn" id="prev-month-btn-reports" title="Mês anterior">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="month-display" id="current-month-display-reports">
                        Carregando...
                    </div>
                    <button class="month-navigation-btn" id="next-month-btn-reports" title="Próximo mês">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div class="text-center">
                    <button class="btn btn-sm btn-outline-primary" id="go-to-current-month-reports">
                        <i class="bi bi-calendar-check me-1"></i>Voltar para mês atual
                    </button>
                </div>
            </div>
            
            <div class="dashboard-card">
                <h4 class="mb-4">Relatórios Financeiros</h4>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="report-period" class="form-label">Período</label>
                            <select class="form-select" id="report-period">
                                <option value="current-month">Este Mês</option>
                                <option value="last-month">Mês Anterior</option>
                                <option value="last-3-months">Últimos 3 Meses</option>
                                <option value="current-year">Este Ano</option>
                                <option value="selected-month">Mês Selecionado</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="report-type" class="form-label">Tipo de Relatório</label>
                            <select class="form-select" id="report-type">
                                <option value="expenses">Despesas por Categoria</option>
                                <option value="income-vs-expenses">Receitas vs Despesas</option>
                                <option value="monthly-trend">Tendência Mensal</option>
                                <option value="status">Status de Efetivação</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" id="generate-report">
                                <i class="bi bi-file-earmark-text me-2"></i>Gerar Relatório
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container mb-4">
                    <canvas id="financial-chart"></canvas>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5 class="mb-3">Resumo Financeiro</h5>
                            <div id="financial-summary">
                                <!-- Resumo será carregado via JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5 class="mb-3">Recomendações</h5>
                            <div id="recommendations">
                                <!-- Recomendações serão carregadas via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão de Adicionar Transação -->
    <div class="btn-add" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
        <i class="bi bi-plus-lg"></i>
    </div>

    <!-- Barra de Navegação Fixa no Rodapé -->
    <nav class="bottom-nav">
        <div class="container">
            <div class="row">
                <div class="nav-item">
                    <a class="nav-link active" href="#" data-section="dashboard">
                        <i class="bi bi-house-door"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="#" data-section="transactions">
                        <i class="bi bi-list-check"></i>
                        <span>Transações</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="#" data-section="budget">
                        <i class="bi bi-pie-chart"></i>
                        <span>Orçamento</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="#" data-section="categories">
                        <i class="bi bi-tags"></i>
                        <span>Categorias</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="#" data-section="reports">
                        <i class="bi bi-bar-chart"></i>
                        <span>Relatórios</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Indicador de Carregamento -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner"></div>
    </div>

    <!-- Modal para Adicionar Transação (Centralizado) -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-centered-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Transação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transaction-form">
                        <div class="mb-3">
                            <label for="transaction-type" class="form-label">Tipo</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="transaction-type" id="type-income" value="income" checked>
                                <label class="btn btn-outline-success" for="type-income">Receita</label>
                                
                                <input type="radio" class="btn-check" name="transaction-type" id="type-expense" value="expense">
                                <label class="btn btn-outline-danger" for="type-expense">Despesa</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="transaction-description" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="transaction-description" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="transaction-amount" class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control" id="transaction-amount" required min="0.01" step="0.01">
                        </div>
                        
                        <div class="mb-3">
                            <label for="transaction-category" class="form-label">Categoria</label>
                            <select class="form-select" id="transaction-category" required>
                                <option value="">Selecione uma categoria</option>
                                <!-- Categorias serão carregadas dinamicamente -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="transaction-date" class="form-label">Data</label>
                            <input type="date" class="form-control" id="transaction-date" required>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="transaction-recurring">
                                <label class="form-check-label" for="transaction-recurring">
                                    Esta é uma transação recorrente
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="recurring-options" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="recurring-frequency" class="form-label">Repetir a cada</label>
                                    <select class="form-select" id="recurring-frequency">
                                        <option value="1">1 mês</option>
                                        <option value="2">2 meses</option>
                                        <option value="3">3 meses</option>
                                        <option value="6">6 meses</option>
                                        <option value="12">1 ano</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="recurring-times" class="form-label">Quantidade de vezes</label>
                                    <input type="number" class="form-control" id="recurring-times" min="1" value="1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="transaction-status" checked>
                                <label class="form-check-label" for="transaction-status">
                                    <i class="bi bi-check-circle text-success me-1"></i>Marcar como efetivada
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="transaction-notes" class="form-label">Observações (opcional)</label>
                            <textarea class="form-control" id="transaction-notes" rows="2"></textarea>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Adicionar Transação</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Transação (Centralizado) -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-centered-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Transação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-transaction-form">
                        <input type="hidden" id="edit-transaction-id">
                        
                        <div class="mb-3">
                            <label for="edit-transaction-type" class="form-label">Tipo</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="edit-transaction-type" id="edit-type-income" value="income">
                                <label class="btn btn-outline-success" for="edit-type-income">Receita</label>
                                
                                <input type="radio" class="btn-check" name="edit-transaction-type" id="edit-type-expense" value="expense">
                                <label class="btn btn-outline-danger" for="edit-type-expense">Despesa</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-transaction-description" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="edit-transaction-description" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-transaction-amount" class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control" id="edit-transaction-amount" required min="0.01" step="0.01">
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-transaction-category" class="form-label">Categoria</label>
                            <select class="form-select" id="edit-transaction-category" required>
                                <option value="">Selecione uma categoria</option>
                                <!-- Categorias serão carregadas dinamicamente -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-transaction-date" class="form-label">Data</label>
                            <input type="date" class="form-control" id="edit-transaction-date" required>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit-transaction-status">
                                <label class="form-check-label" for="edit-transaction-status">
                                    <i class="bi bi-check-circle text-success me-1"></i>Marcar como efetivada
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-transaction-notes" class="form-label">Observações (opcional)</label>
                            <textarea class="form-control" id="edit-transaction-notes" rows="2"></textarea>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Categoria (Centralizado) -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-centered-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Nova Categoria</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="category-form">
                        <div class="mb-3">
                            <label for="category-name" class="form-label">Nome da Categoria</label>
                            <input type="text" class="form-control" id="category-name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category-type" class="form-label">Tipo</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="category-type" id="category-income" value="income" checked>
                                <label class="btn btn-outline-success" for="category-income">Receita</label>
                                
                                <input type="radio" class="btn-check" name="category-type" id="category-expense" value="expense">
                                <label class="btn btn-outline-danger" for="category-expense">Despesa</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category-color" class="form-label">Cor (opcional)</label>
                            <div class="d-flex">
                                <input type="color" class="form-control form-control-color" id="category-color" value="#4361ee" title="Escolha uma cor">
                                <div class="ms-3">
                                    <div class="category-badge" id="category-preview" style="background-color: #4361ee; color: white;">Exemplo</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category-icon" class="form-label">Ícone (opcional)</label>
                            <select class="form-select" id="category-icon">
                                <option value="bi-cash">Dinheiro</option>
                                <option value="bi-cart">Carrinho</option>
                                <option value="bi-house">Casa</option>
                                <option value="bi-car-front">Carro</option>
                                <option value="bi-heart">Saúde</option>
                                <option value="bi-book">Educação</option>
                                <option value="bi-cup-straw">Lazer</option>
                                <option value="bi-gift">Presente</option>
                                <option value="bi-phone">Telefone</option>
                                <option value="bi-wifi">Internet</option>
                            </select>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Adicionar Categoria</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Categoria (Centralizado) -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-centered-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Categoria</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-category-form">
                        <input type="hidden" id="edit-category-id">
                        
                        <div class="mb-3">
                            <label for="edit-category-name" class="form-label">Nome da Categoria</label>
                            <input type="text" class="form-control" id="edit-category-name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-category-type" class="form-label">Tipo</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="edit-category-type" id="edit-category-income" value="income">
                                <label class="btn btn-outline-success" for="edit-category-income">Receita</label>
                                
                                <input type="radio" class="btn-check" name="edit-category-type" id="edit-category-expense" value="expense">
                                <label class="btn btn-outline-danger" for="edit-category-expense">Despesa</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-category-color" class="form-label">Cor</label>
                            <div class="d-flex">
                                <input type="color" class="form-control form-control-color" id="edit-category-color" value="#4361ee" title="Escolha uma cor">
                                <div class="ms-3">
                                    <div class="category-badge" id="edit-category-preview" style="background-color: #4361ee; color: white;">Exemplo</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-category-icon" class="form-label">Ícone</label>
                            <select class="form-select" id="edit-category-icon">
                                <option value="bi-cash">Dinheiro</option>
                                <option value="bi-cart">Carrinho</option>
                                <option value="bi-house">Casa</option>
                                <option value="bi-car-front">Carro</option>
                                <option value="bi-heart">Saúde</option>
                                <option value="bi-book">Educação</option>
                                <option value="bi-cup-straw">Lazer</option>
                                <option value="bi-gift">Presente</option>
                                <option value="bi-phone">Telefone</option>
                                <option value="bi-wifi">Internet</option>
                            </select>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação (Centralizado) -->
    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-centered-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalTitle">Confirmação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmationModalConfirm">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Notificação (Centralizado) -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-centered-custom">
            <div class="modal-content">
                <div class="modal-header" id="notificationModalHeader">
                    <h5 class="modal-title" id="notificationModalTitle">Notificação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="notificationModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuração do IndexedDB
        const DB_NAME = 'FinancasProDB';
        const DB_VERSION = 2; // Aumentado para versão 2 para adicionar campo de status
        let db = null;

        // Nomes das stores (tabelas)
        const STORES = {
            TRANSACTIONS: 'transactions',
            CATEGORIES: 'categories',
            BUDGETS: 'budgets',
            UPCOMING_BILLS: 'upcomingBills'
        };

        // Dados em memória
        let transactions = [];
        let categories = [];
        let budgets = [];
        let upcomingBills = [];

        // Configurar data atual no campo de data
        document.getElementById('transaction-date').valueAsDate = new Date();

        // Inicializar gráfico
        let financialChart = null;

        // Variáveis para controle de confirmações
        let confirmationCallback = null;
        let currentTransactionId = null;
        let currentCategoryId = null;
        let currentBudgetCategory = null;

        // Variável para controle do mês selecionado
        let currentSelectedMonth = new Date().getMonth();
        let currentSelectedYear = new Date().getFullYear();
        let currentSelectedDate = new Date();

        // ============= INDEXEDDB FUNCTIONS =============
        
        // Inicializar o banco de dados
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error('Erro ao abrir o banco de dados:', event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Banco de dados aberto com sucesso');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;
                    
                    // Criar stores se não existirem
                    if (!db.objectStoreNames.contains(STORES.TRANSACTIONS)) {
                        const transactionStore = db.createObjectStore(STORES.TRANSACTIONS, { keyPath: 'id', autoIncrement: true });
                        transactionStore.createIndex('type', 'type', { unique: false });
                        transactionStore.createIndex('category', 'category', { unique: false });
                        transactionStore.createIndex('date', 'date', { unique: false });
                        transactionStore.createIndex('status', 'status', { unique: false });
                    } else if (oldVersion < 2) {
                        // Atualizar para versão 2: adicionar campo de status
                        const transactionStore = event.currentTarget.transaction.objectStore(STORES.TRANSACTIONS);
                        
                        // Criar novo índice para status
                        if (!transactionStore.indexNames.contains('status')) {
                            transactionStore.createIndex('status', 'status', { unique: false });
                        }
                        
                        // Atualizar transações existentes para ter status 'completed'
                        const getAllRequest = transactionStore.getAll();
                        getAllRequest.onsuccess = function() {
                            const allTransactions = getAllRequest.result;
                            allTransactions.forEach(transaction => {
                                if (transaction.status === undefined) {
                                    transaction.status = 'completed';
                                    transactionStore.put(transaction);
                                }
                            });
                        };
                    }
                    
                    if (!db.objectStoreNames.contains(STORES.CATEGORIES)) {
                        const categoryStore = db.createObjectStore(STORES.CATEGORIES, { keyPath: 'id', autoIncrement: true });
                        categoryStore.createIndex('type', 'type', { unique: false });
                        categoryStore.createIndex('name', 'name', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains(STORES.BUDGETS)) {
                        const budgetStore = db.createObjectStore(STORES.BUDGETS, { keyPath: 'category' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORES.UPCOMING_BILLS)) {
                        const upcomingBillsStore = db.createObjectStore(STORES.UPCOMING_BILLS, { keyPath: 'id', autoIncrement: true });
                        upcomingBillsStore.createIndex('dueDate', 'dueDate', { unique: false });
                    }
                    
                    console.log('Estrutura do banco de dados criada/atualizada');
                };
            });
        }

        // Carregar todos os dados do IndexedDB
        async function loadAllData() {
            try {
                showLoading(true);
                
                // Carregar transações
                transactions = await getAllFromStore(STORES.TRANSACTIONS);
                
                // Garantir que todas as transações tenham status
                transactions.forEach(transaction => {
                    if (transaction.status === undefined) {
                        transaction.status = 'completed';
                    }
                });
                
                // Carregar categorias
                categories = await getAllFromStore(STORES.CATEGORIES);
                
                // Se não houver categorias, adicionar as padrão
                if (categories.length === 0) {
                    await addDefaultCategories();
                    categories = await getAllFromStore(STORES.CATEGORIES);
                }
                
                // Carregar orçamentos
                budgets = await getAllFromStore(STORES.BUDGETS);
                
                // Carregar contas próximas
                upcomingBills = await getAllFromStore(STORES.UPCOMING_BILLS);
                
                console.log('Dados carregados com sucesso:', {
                    transactions: transactions.length,
                    categories: categories.length,
                    budgets: budgets.length,
                    upcomingBills: upcomingBills.length
                });
                
                return true;
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('Erro', 'Não foi possível carregar os dados. Por favor, recarregue a página.', 'danger');
                return false;
            } finally {
                showLoading(false);
            }
        }

        // Obter todos os registros de uma store
        function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Banco de dados não inicializado'));
                    return;
                }
                
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = (event) => {
                    resolve(event.target.result || []);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // Adicionar um item a uma store
        function addToStore(storeName, item) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Banco de dados não inicializado'));
                    return;
                }
                
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(item);
                
                request.onsuccess = (event) => {
                    // Se o store usar auto-increment, atualizar o ID do item
                    if (store.keyPath === 'id' && item.id === undefined) {
                        item.id = event.target.result;
                    }
                    resolve(item);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // Atualizar um item em uma store
        function updateInStore(storeName, item) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Banco de dados não inicializado'));
                    return;
                }
                
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(item);
                
                request.onsuccess = () => {
                    resolve(item);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // Remover um item de uma store
        function removeFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Banco de dados não inicializado'));
                    return;
                }
                
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                
                request.onsuccess = () => {
                    resolve(true);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // Adicionar categorias padrão
        async function addDefaultCategories() {
            const defaultCategories = [
                { id: 1, name: 'Salário', type: 'income', color: '#4cc9f0', icon: 'bi-cash' },
                { id: 2, name: 'Freelance', type: 'income', color: '#3f37c9', icon: 'bi-laptop' },
                { id: 3, name: 'Investimentos', type: 'income', color: '#4361ee', icon: 'bi-graph-up' },
                { id: 4, name: 'Alimentação', type: 'expense', color: '#f72585', icon: 'bi-cart' },
                { id: 5, name: 'Transporte', type: 'expense', color: '#ff9e00', icon: 'bi-car-front' },
                { id: 6, name: 'Moradia', type: 'expense', color: '#7209b7', icon: 'bi-house' },
                { id: 7, name: 'Lazer', type: 'expense', color: '#4cc9f0', icon: 'bi-cup-straw' },
                { id: 8, name: 'Saúde', type: 'expense', color: '#f72585', icon: 'bi-heart' },
                { id: 9, name: 'Educação', type: 'expense', color: '#3f37c9', icon: 'bi-book' }
            ];
            
            for (const category of defaultCategories) {
                try {
                    await addToStore(STORES.CATEGORIES, category);
                } catch (error) {
                    console.error('Erro ao adicionar categoria padrão:', error);
                }
            }
        }

        // ============= UTILITY FUNCTIONS =============
        
        // Mostrar/ocultar indicador de carregamento
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('d-none');
            } else {
                overlay.classList.add('d-none');
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Formatar mês e ano para exibição
        function formatMonthYear(month, year) {
            const date = new Date(year, month, 1);
            return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        }

        // Verificar se é o mês atual
        function isCurrentMonth(month, year) {
            const currentDate = new Date();
            return month === currentDate.getMonth() && year === currentDate.getFullYear();
        }

        // Atualizar a exibição do mês atual
        function updateMonthDisplay() {
            const formattedMonth = formatMonthYear(currentSelectedMonth, currentSelectedYear);
            const isCurrent = isCurrentMonth(currentSelectedMonth, currentSelectedYear);
            
            // Atualizar todos os displays de mês
            document.querySelectorAll('.month-display').forEach(display => {
                display.innerHTML = `
                    ${formattedMonth.charAt(0).toUpperCase() + formattedMonth.slice(1)}
                    ${isCurrent ? '<span class="current-month-badge">Mês Atual</span>' : ''}
                `;
            });
        }

        // Navegar para o mês anterior
        function goToPreviousMonth() {
            currentSelectedMonth--;
            if (currentSelectedMonth < 0) {
                currentSelectedMonth = 11;
                currentSelectedYear--;
            }
            currentSelectedDate = new Date(currentSelectedYear, currentSelectedMonth, 1);
            updateMonthDisplay();
            refreshCurrentSection();
        }

        // Navegar para o próximo mês
        function goToNextMonth() {
            currentSelectedMonth++;
            if (currentSelectedMonth > 11) {
                currentSelectedMonth = 0;
                currentSelectedYear++;
            }
            currentSelectedDate = new Date(currentSelectedYear, currentSelectedMonth, 1);
            updateMonthDisplay();
            refreshCurrentSection();
        }

        // Voltar para o mês atual
        function goToCurrentMonth() {
            const currentDate = new Date();
            currentSelectedMonth = currentDate.getMonth();
            currentSelectedYear = currentDate.getFullYear();
            currentSelectedDate = new Date();
            updateMonthDisplay();
            refreshCurrentSection();
        }

        // Atualizar a seção atual
        function refreshCurrentSection() {
            const activeSection = document.querySelector('.bottom-nav .nav-link.active').getAttribute('data-section');
            
            if (activeSection === 'dashboard') {
                updateDashboard();
                renderTransactions(filterTransactionsByMonth('all'), 'transactions-list', 5);
                renderExpenseCategories();
            } else if (activeSection === 'transactions') {
                renderTransactions(filterTransactionsByMonth('all'), 'all-transactions-list');
                updateStatusSummary();
            } else if (activeSection === 'budget') {
                renderBudgets();
            } else if (activeSection === 'reports') {
                generateReport('selected-month', 'expenses');
            }
        }

        // Calcular totais do mês selecionado (apenas transações efetivadas)
        function calculateMonthlyTotals() {
            let monthlyIncome = 0;
            let monthlyExpense = 0;
            let monthlyPendingIncome = 0;
            let monthlyPendingExpense = 0;
            
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                if (transactionDate.getMonth() === currentSelectedMonth && 
                    transactionDate.getFullYear() === currentSelectedYear) {
                    
                    if (transaction.status === 'completed') {
                        if (transaction.type === 'income') {
                            monthlyIncome += transaction.amount;
                        } else {
                            monthlyExpense += transaction.amount;
                        }
                    } else if (transaction.status === 'pending') {
                        if (transaction.type === 'income') {
                            monthlyPendingIncome += transaction.amount;
                        } else {
                            monthlyPendingExpense += transaction.amount;
                        }
                    }
                }
            });
            
            return {
                income: monthlyIncome,
                expense: monthlyExpense,
                pendingIncome: monthlyPendingIncome,
                pendingExpense: monthlyPendingExpense,
                balance: monthlyIncome - monthlyExpense,
                pendingBalance: monthlyPendingIncome - monthlyPendingExpense
            };
        }

        // Calcular totais gerais (apenas transações efetivadas)
        function calculateTotals() {
            let totalIncome = 0;
            let totalExpense = 0;
            let totalPendingIncome = 0;
            let totalPendingExpense = 0;
            
            transactions.forEach(transaction => {
                if (transaction.status === 'completed') {
                    if (transaction.type === 'income') {
                        totalIncome += transaction.amount;
                    } else {
                        totalExpense += transaction.amount;
                    }
                } else if (transaction.status === 'pending') {
                    if (transaction.type === 'income') {
                        totalPendingIncome += transaction.amount;
                    } else {
                        totalPendingExpense += transaction.amount;
                    }
                }
            });
            
            return {
                income: totalIncome,
                expense: totalExpense,
                pendingIncome: totalPendingIncome,
                pendingExpense: totalPendingExpense,
                balance: totalIncome - totalExpense,
                pendingBalance: totalPendingIncome - totalPendingExpense
            };
        }

        // Mostrar modal de confirmação
        function showConfirmation(title, message, confirmCallback) {
            document.getElementById('confirmationModalTitle').textContent = title;
            document.getElementById('confirmationModalBody').textContent = message;
            confirmationCallback = confirmCallback;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            modal.show();
        }

        // Mostrar modal de notificação
        function showNotification(title, message, type = 'info') {
            document.getElementById('notificationModalTitle').textContent = title;
            document.getElementById('notificationModalBody').textContent = message;
            
            // Alterar cor do cabeçalho baseado no tipo
            const modalHeader = document.getElementById('notificationModalHeader');
            modalHeader.className = 'modal-header';
            
            if (type === 'success') {
                modalHeader.classList.add('bg-success', 'text-white');
            } else if (type === 'warning') {
                modalHeader.classList.add('bg-warning', 'text-dark');
            } else if (type === 'danger') {
                modalHeader.classList.add('bg-danger', 'text-white');
            } else {
                modalHeader.classList.add('bg-primary', 'text-white');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
            modal.show();
        }

        // ============= RENDER FUNCTIONS =============

        // Renderizar categorias nos selects
        function renderCategoryOptions() {
            const categorySelects = [
                document.getElementById('transaction-category'),
                document.getElementById('edit-transaction-category'),
                document.getElementById('filter-category'),
                document.getElementById('budget-category')
            ];
            
            categorySelects.forEach(select => {
                if (!select) return;
                
                // Salvar valor atual
                const currentValue = select.value;
                
                // Limpar opções exceto a primeira
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Adicionar categorias de receitas
                const incomeCategories = categories.filter(c => c.type === 'income');
                if (incomeCategories.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = 'Receitas';
                    incomeCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.name;
                        option.textContent = category.name;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                }
                
                // Adicionar categorias de despesas
                const expenseCategories = categories.filter(c => c.type === 'expense');
                if (expenseCategories.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = 'Despesas';
                    expenseCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.name;
                        option.textContent = category.name;
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                }
                
                // Restaurar valor atual se ainda existir
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        // Filtrar transações por mês selecionado
        function filterTransactionsByMonth(type = 'all', search = '', category = '', status = 'all') {
            let filtered = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.getMonth() === currentSelectedMonth && 
                       transactionDate.getFullYear() === currentSelectedYear;
            });
            
            if (type !== 'all') {
                filtered = filtered.filter(t => t.type === type);
            }
            
            if (status !== 'all') {
                filtered = filtered.filter(t => t.status === status);
            }
            
            if (search) {
                const searchLower = search.toLowerCase();
                filtered = filtered.filter(t => 
                    t.description.toLowerCase().includes(searchLower) || 
                    t.category.toLowerCase().includes(searchLower) ||
                    (t.notes && t.notes.toLowerCase().includes(searchLower))
                );
            }
            
            if (category) {
                filtered = filtered.filter(t => t.category === category);
            }
            
            // Ordenar por data (mais recente primeiro)
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Filtrar todas as transações (para seção de transações)
        function filterAllTransactions(type = 'all', search = '', category = '', monthFilter = 'all', statusFilter = 'all') {
            let filtered = transactions;
            
            if (type !== 'all') {
                filtered = filtered.filter(t => t.type === type);
            }
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(t => t.status === statusFilter);
            }
            
            if (search) {
                const searchLower = search.toLowerCase();
                filtered = filtered.filter(t => 
                    t.description.toLowerCase().includes(searchLower) || 
                    t.category.toLowerCase().includes(searchLower) ||
                    (t.notes && t.notes.toLowerCase().includes(searchLower))
                );
            }
            
            if (category) {
                filtered = filtered.filter(t => t.category === category);
            }
            
            if (monthFilter !== 'all') {
                const monthNum = parseInt(monthFilter);
                filtered = filtered.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getMonth() === monthNum;
                });
            }
            
            // Ordenar por data (mais recente primeiro)
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Atualizar resumo de status
        function updateStatusSummary() {
            const monthlyTransactions = filterTransactionsByMonth('all');
            const completedCount = monthlyTransactions.filter(t => t.status === 'completed').length;
            const pendingCount = monthlyTransactions.filter(t => t.status === 'pending').length;
            const totalCount = monthlyTransactions.length;
            const completionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            document.getElementById('completed-count').textContent = completedCount;
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('completion-rate').className = `status-summary-value ${completionRate === 100 ? 'text-success' : completionRate >= 70 ? 'text-warning' : 'text-danger'}`;
        }

        // Renderizar transações
        function renderTransactions(transactionsToRender, containerId, limit = null) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '';
            const transactionsList = limit ? transactionsToRender.slice(0, limit) : transactionsToRender;
            
            if (transactionsList.length === 0) {
                html = '<div class="empty-state"><i class="bi bi-receipt"></i><p>Nenhuma transação encontrada.</p></div>';
            } else {
                transactionsList.forEach(transaction => {
                    const isIncome = transaction.type === 'income';
                    const isCompleted = transaction.status === 'completed';
                    const categoryObj = categories.find(c => c.name === transaction.category);
                    const iconClass = categoryObj ? categoryObj.icon : (isIncome ? 'bi-arrow-down-left' : 'bi-arrow-up-right');
                    const typeClass = isIncome ? 'transaction-income' : 'transaction-expense';
                    const statusClass = isCompleted ? 'completed' : 'pending';
                    const categoryColor = categoryObj ? categoryObj.color : (isIncome ? '#4cc9f0' : '#f72585');
                    const statusBadge = isCompleted ? 
                        '<span class="status-badge status-completed"><i class="bi bi-check-circle me-1"></i>Efetivada</span>' :
                        '<span class="status-badge status-pending"><i class="bi bi-clock me-1"></i>Pendente</span>';
                    
                    html += `
                        <div class="transaction-item ${typeClass} ${statusClass}" data-id="${transaction.id}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="category-icon me-3" style="background-color: ${categoryColor}20; color: ${categoryColor};">
                                        <i class="bi ${iconClass}"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">${transaction.description}</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="category-badge me-2" style="background-color: ${categoryColor}30; color: ${categoryColor}; border: 1px solid ${categoryColor}50;">${transaction.category}</span>
                                            <small class="text-muted">${formatDate(transaction.date)}</small>
                                            ${statusBadge}
                                            ${transaction.recurring ? '<span class="recurring-badge ms-2"><i class="bi bi-arrow-repeat me-1"></i>Recorrente</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="amount">${isIncome ? '+' : '-'} ${formatCurrency(transaction.amount)}</div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-secondary btn-action toggle-status" data-id="${transaction.id}" title="${isCompleted ? 'Marcar como pendente' : 'Marcar como efetivada'}">
                                            <i class="bi ${isCompleted ? 'bi-arrow-counterclockwise' : 'bi-check-circle'}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary btn-action edit-transaction" data-id="${transaction.id}" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger btn-action delete-transaction" data-id="${transaction.id}" title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ${transaction.notes ? `<small class="text-muted mt-2 d-block"><i>${transaction.notes}</i></small>` : ''}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Adicionar eventos aos botões
            container.querySelectorAll('.toggle-status').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const transactionId = parseInt(this.getAttribute('data-id'));
                    toggleTransactionStatus(transactionId);
                });
            });
            
            container.querySelectorAll('.edit-transaction').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const transactionId = parseInt(this.getAttribute('data-id'));
                    editTransaction(transactionId);
                });
            });
            
            container.querySelectorAll('.delete-transaction').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    currentTransactionId = parseInt(this.getAttribute('data-id'));
                    showConfirmation(
                        'Excluir Transação',
                        'Tem certeza que deseja excluir esta transação?',
                        deleteTransaction
                    );
                });
            });
        }

        // Renderizar categorias de despesas
        function renderExpenseCategories() {
            const container = document.getElementById('expense-categories');
            if (!container) return;
            
            // Calcular totais por categoria do mês selecionado (apenas efetivadas)
            const categoryTotals = {};
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                if (transaction.type === 'expense' && 
                    transaction.status === 'completed' &&
                    transactionDate.getMonth() === currentSelectedMonth && 
                    transactionDate.getFullYear() === currentSelectedYear) {
                    
                    if (!categoryTotals[transaction.category]) {
                        categoryTotals[transaction.category] = 0;
                    }
                    categoryTotals[transaction.category] += transaction.amount;
                }
            });
            
            let html = '';
            for (const [category, total] of Object.entries(categoryTotals)) {
                // Encontrar orçamento para esta categoria
                const budgetItem = budgets.find(b => b.category === category);
                const budget = budgetItem ? budgetItem.budget : 0;
                const percentage = budget > 0 ? Math.min(100, (total / budget) * 100) : 100;
                const progressClass = percentage > 90 ? 'bg-danger' : percentage > 70 ? 'bg-warning' : 'bg-success';
                
                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>${category}</span>
                            <span><strong>${formatCurrency(total)}</strong>${budget > 0 ? ` / ${formatCurrency(budget)}` : ''}</span>
                        </div>
                        ${budget > 0 ? `
                            <div class="progress progress-bar-custom">
                                <div class="progress-bar ${progressClass}" role="progressbar" style="width: ${percentage}%"></div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            if (html === '') {
                html = '<div class="empty-state"><i class="bi bi-pie-chart"></i><p>Nenhuma despesa registrada neste mês.</p></div>';
            }
            
            container.innerHTML = html;
        }

        // Renderizar listas de categorias
        function renderCategoryLists() {
            const incomeContainer = document.getElementById('income-categories-list');
            const expenseContainer = document.getElementById('expense-categories-list');
            
            // Categorias de receitas
            let incomeHtml = '';
            const incomeCategories = categories.filter(c => c.type === 'income');
            
            if (incomeCategories.length === 0) {
                incomeHtml = '<div class="empty-state"><i class="bi bi-tag"></i><p>Nenhuma categoria de receita cadastrada.</p></div>';
            } else {
                incomeCategories.forEach(category => {
                    incomeHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                            <div class="d-flex align-items-center">
                                <div class="category-icon me-3" style="background-color: ${category.color}20; color: ${category.color};">
                                    <i class="bi ${category.icon}"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">${category.name}</h6>
                                    <small class="text-muted">${category.type === 'income' ? 'Receita' : 'Despesa'}</small>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary btn-action edit-category" data-id="${category.id}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-action delete-category" data-id="${category.id}" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Categorias de despesas
            let expenseHtml = '';
            const expenseCategories = categories.filter(c => c.type === 'expense');
            
            if (expenseCategories.length === 0) {
                expenseHtml = '<div class="empty-state"><i class="bi bi-tag"></i><p>Nenhuma categoria de despesa cadastrada.</p></div>';
            } else {
                expenseCategories.forEach(category => {
                    expenseHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                            <div class="d-flex align-items-center">
                                <div class="category-icon me-3" style="background-color: ${category.color}20; color: ${category.color};">
                                    <i class="bi ${category.icon}"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">${category.name}</h6>
                                    <small class="text-muted">${category.type === 'income' ? 'Receita' : 'Despesa'}</small>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary btn-action edit-category" data-id="${category.id}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-action delete-category" data-id="${category.id}" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (incomeContainer) incomeContainer.innerHTML = incomeHtml;
            if (expenseContainer) expenseContainer.innerHTML = expenseHtml;
            
            // Adicionar eventos aos botões
            document.querySelectorAll('.edit-category').forEach(button => {
                button.addEventListener('click', function() {
                    const categoryId = parseInt(this.getAttribute('data-id'));
                    editCategory(categoryId);
                });
            });
            
            document.querySelectorAll('.delete-category').forEach(button => {
                button.addEventListener('click', function() {
                    currentCategoryId = parseInt(this.getAttribute('data-id'));
                    showConfirmation(
                        'Excluir Categoria',
                        'Tem certeza que deseja excluir esta categoria?',
                        deleteCategory
                    );
                });
            });
        }

        // Renderizar próximas contas
        function renderUpcomingBills() {
            const container = document.getElementById('upcoming-bills');
            if (!container) return;
            
            let html = '';
            
            // Filtrar apenas contas futuras
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const futureBills = upcomingBills.filter(bill => {
                const dueDate = new Date(bill.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return dueDate >= today;
            }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            if (futureBills.length === 0) {
                html = '<div class="empty-state"><i class="bi bi-calendar-check"></i><p>Nenhuma conta a vencer.</p></div>';
            } else {
                futureBills.slice(0, 5).forEach(bill => {
                    const daysUntilDue = Math.ceil((new Date(bill.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                    const dueText = daysUntilDue === 0 ? 'Vence hoje' : daysUntilDue < 0 ? `Venceu há ${Math.abs(daysUntilDue)} dias` : `Vence em ${daysUntilDue} dias`;
                    const dueClass = daysUntilDue <= 3 ? 'text-danger' : daysUntilDue <= 7 ? 'text-warning' : 'text-muted';
                    
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                            <div>
                                <h6 class="mb-1">${bill.description}</h6>
                                <small class="${dueClass}">${dueText}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">${formatCurrency(bill.amount)}</div>
                                <small class="text-muted">${bill.category}</small>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // Renderizar orçamentos
        function renderBudgets() {
            const container = document.getElementById('budget-categories');
            if (!container) return;
            
            let html = '';
            
            if (budgets.length === 0) {
                html = '<div class="empty-state"><i class="bi bi-pie-chart"></i><p>Nenhum orçamento definido ainda.</p></div>';
            } else {
                budgets.forEach(budget => {
                    // Calcular gastos do mês selecionado para esta categoria (apenas efetivadas)
                    const spentThisMonth = transactions
                        .filter(t => {
                            const transactionDate = new Date(t.date);
                            return t.type === 'expense' && 
                                   t.status === 'completed' &&
                                   t.category === budget.category &&
                                   transactionDate.getMonth() === currentSelectedMonth &&
                                   transactionDate.getFullYear() === currentSelectedYear;
                        })
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const percentage = Math.min(100, (spentThisMonth / budget.budget) * 100);
                    const progressClass = percentage > 90 ? 'bg-danger' : percentage > 70 ? 'bg-warning' : 'bg-success';
                    const remaining = budget.budget - spentThisMonth;
                    
                    html += `
                        <div class="dashboard-card mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <h6>${budget.category}</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger btn-action delete-budget" data-category="${budget.category}" title="Remover orçamento">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <span class="text-muted">Gasto: </span>
                                    <strong>${formatCurrency(spentThisMonth)}</strong>
                                    <span class="text-muted"> de ${formatCurrency(budget.budget)}</span>
                                </div>
                            </div>
                            <div class="progress progress-bar-custom mb-2">
                                <div class="progress-bar ${progressClass}" role="progressbar" style="width: ${percentage}%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">${percentage.toFixed(1)}% do orçamento</small>
                                <small class="${remaining >= 0 ? 'text-success' : 'text-danger'}">
                                    ${remaining >= 0 ? 'Restante: ' : 'Excedido: '} ${formatCurrency(Math.abs(remaining))}
                                </small>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Adicionar eventos aos botões de exclusão de orçamento
            container.querySelectorAll('.delete-budget').forEach(button => {
                button.addEventListener('click', function() {
                    currentBudgetCategory = this.getAttribute('data-category');
                    showConfirmation(
                        'Remover Orçamento',
                        `Tem certeza que deseja remover o orçamento para ${currentBudgetCategory}?`,
                        deleteBudget
                    );
                });
            });
        }

        // Atualizar dashboard
        function updateDashboard() {
            const totals = calculateTotals();
            const monthlyTotals = calculateMonthlyTotals();
            
            // Atualizar saldo total (apenas efetivadas)
            document.getElementById('total-balance').textContent = formatCurrency(totals.balance);
            
            // Atualizar mudança mensal (apenas efetivadas)
            const monthlyChangeElement = document.getElementById('monthly-balance-change');
            if (monthlyTotals.balance > 0) {
                monthlyChangeElement.innerHTML = `<i class="bi bi-arrow-up-circle me-1"></i> ${formatCurrency(monthlyTotals.balance)} este mês`;
                monthlyChangeElement.className = 'mb-0 text-success';
            } else if (monthlyTotals.balance < 0) {
                monthlyChangeElement.innerHTML = `<i class="bi bi-arrow-down-circle me-1"></i> ${formatCurrency(Math.abs(monthlyTotals.balance))} este mês`;
                monthlyChangeElement.className = 'mb-0 text-danger';
            } else {
                monthlyChangeElement.innerHTML = `<i class="bi bi-dash-circle me-1"></i> R$ 0,00 este mês`;
                monthlyChangeElement.className = 'mb-0 text-muted';
            }
            
            // Atualizar receitas e despesas do mês (apenas efetivadas)
            document.getElementById('monthly-income').textContent = formatCurrency(monthlyTotals.income);
            document.getElementById('monthly-expense').textContent = formatCurrency(monthlyTotals.expense);
            
            // Atualizar metas
            updateGoals();
            
            // Atualizar os cartões de estatísticas do mês (apenas efetivadas)
            document.getElementById('stat-income').textContent = formatCurrency(monthlyTotals.income);
            document.getElementById('stat-expense').textContent = formatCurrency(monthlyTotals.expense);
            document.getElementById('stat-savings').textContent = formatCurrency(monthlyTotals.balance);
            
            // Atualizar contador de transações do mês (todas)
            const monthlyTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.getMonth() === currentSelectedMonth && 
                       transactionDate.getFullYear() === currentSelectedYear;
            });
            document.getElementById('transaction-count').textContent = monthlyTransactions.length;
        }

        // Atualizar metas
        function updateGoals() {
            // Meta de economia (exemplo: 20% da renda mensal) - apenas efetivadas
            const monthlyTotals = calculateMonthlyTotals();
            const savingsGoal = monthlyTotals.income * 0.2; // 20% da renda
            const currentSavings = Math.max(0, monthlyTotals.balance);
            const savingsPercentage = savingsGoal > 0 ? Math.min(100, (currentSavings / savingsGoal) * 100) : 0;
            
            document.getElementById('savings-progress').textContent = 
                `${formatCurrency(currentSavings)} / ${formatCurrency(savingsGoal)}`;
            document.getElementById('savings-bar').style.width = `${savingsPercentage}%`;
            
            // Meta de alimentação
            const foodBudget = budgets.find(b => b.category === 'Alimentação');
            if (foodBudget) {
                // Calcular gastos com alimentação no mês selecionado (apenas efetivadas)
                const foodSpent = transactions
                    .filter(t => {
                        const transactionDate = new Date(t.date);
                        return t.type === 'expense' && 
                               t.status === 'completed' &&
                               t.category === 'Alimentação' &&
                               transactionDate.getMonth() === currentSelectedMonth &&
                               transactionDate.getFullYear() === currentSelectedYear;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const foodPercentage = Math.min(100, (foodSpent / foodBudget.budget) * 100);
                
                document.getElementById('food-progress').textContent = 
                    `${formatCurrency(foodSpent)} / ${formatCurrency(foodBudget.budget)}`;
                document.getElementById('food-bar').style.width = `${foodPercentage}%`;
            } else {
                document.getElementById('food-progress').textContent = 'R$ 0,00 / R$ 0,00';
                document.getElementById('food-bar').style.width = '0%';
            }
        }

        // ============= CRUD OPERATIONS =============

        // Adicionar transação
        async function addTransaction(transactionData) {
            const {
                type,
                description,
                amount,
                category,
                date,
                notes,
                recurring,
                frequency,
                times,
                status
            } = transactionData;
            
            try {
                showLoading(true);
                
                const newTransactions = [];
                const statusValue = status ? 'completed' : 'pending';
                
                // Verificar se é uma transação recorrente
                if (recurring && times > 1) {
                    for (let i = 0; i < times; i++) {
                        const transactionDate = new Date(date);
                        transactionDate.setMonth(transactionDate.getMonth() + (i * frequency));
                        
                        const newTransaction = {
                            type,
                            description,
                            amount,
                            category,
                            date: transactionDate.toISOString().split('T')[0],
                            notes: notes || '',
                            recurring: true,
                            status: statusValue,
                            originalTransactionId: i === 0 ? null : undefined
                        };
                        
                        // Adicionar ao IndexedDB
                        const savedTransaction = await addToStore(STORES.TRANSACTIONS, newTransaction);
                        newTransactions.push(savedTransaction);
                        
                        // Adicionar à lista de contas próximas se for uma despesa recorrente
                        if (type === 'expense') {
                            const dueDate = new Date(transactionDate);
                            dueDate.setMonth(dueDate.getMonth() + 1); // Próximo mês
                            
                            await addToStore(STORES.UPCOMING_BILLS, {
                                description,
                                amount,
                                dueDate: dueDate.toISOString().split('T')[0],
                                category
                            });
                        }
                    }
                } else {
                    const newTransaction = {
                        type,
                        description,
                        amount,
                        category,
                        date,
                        notes: notes || '',
                        recurring: recurring || false,
                        status: statusValue,
                        originalTransactionId: null
                    };
                    
                    // Adicionar ao IndexedDB
                    const savedTransaction = await addToStore(STORES.TRANSACTIONS, newTransaction);
                    newTransactions.push(savedTransaction);
                    
                    // Adicionar à lista de contas próximas se for uma despesa recorrente
                    if (recurring && type === 'expense') {
                        const dueDate = new Date(date);
                        dueDate.setMonth(dueDate.getMonth() + 1); // Próximo mês
                        
                        await addToStore(STORES.UPCOMING_BILLS, {
                            description,
                            amount,
                            dueDate: dueDate.toISOString().split('T')[0],
                            category
                        });
                    }
                }
                
                // Atualizar dados em memória
                await loadAllData();
                
                // Atualizar a interface
                updateDashboard();
                renderTransactions(filterTransactionsByMonth('all'), 'transactions-list', 5);
                renderTransactions(filterAllTransactions('all', '', '', currentSelectedMonth.toString(), 'all'), 'all-transactions-list');
                updateStatusSummary();
                renderExpenseCategories();
                renderBudgets();
                renderUpcomingBills();
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addTransactionModal'));
                if (modal) modal.hide();
                
                // Resetar formulário
                document.getElementById('transaction-form').reset();
                document.getElementById('transaction-date').valueAsDate = new Date();
                document.getElementById('type-income').checked = true;
                document.getElementById('transaction-recurring').checked = false;
                document.getElementById('transaction-status').checked = true;
                document.getElementById('recurring-options').style.display = 'none';
                
                // Mostrar mensagem de sucesso
                const message = newTransactions.length > 1 
                    ? `${newTransactions.length} transações recorrentes adicionadas com sucesso!` 
                    : `Transação adicionada com sucesso${statusValue === 'pending' ? ' (pendente)' : ' (efetivada)'}!`;
                showNotification('Sucesso', message, 'success');
                
            } catch (error) {
                console.error('Erro ao adicionar transação:', error);
                showNotification('Erro', 'Não foi possível adicionar a transação. Por favor, tente novamente.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Alternar status da transação
        async function toggleTransactionStatus(transactionId) {
            try {
                showLoading(true);
                
                // Encontrar transação
                const transactionIndex = transactions.findIndex(t => t.id === transactionId);
                if (transactionIndex === -1) {
                    showNotification('Erro', 'Transação não encontrada.', 'danger');
                    return;
                }
                
                const transaction = transactions[transactionIndex];
                const newStatus = transaction.status === 'completed' ? 'pending' : 'completed';
                
                // Atualizar transação
                const updatedTransaction = {
                    ...transaction,
                    status: newStatus
                };
                
                // Atualizar no IndexedDB
                await updateInStore(STORES.TRANSACTIONS, updatedTransaction);
                
                // Atualizar dados em memória
                transactions[transactionIndex] = updatedTransaction;
                
                // Atualizar a interface
                updateDashboard();
                renderTransactions(filterTransactionsByMonth('all'), 'transactions-list', 5);
                renderTransactions(filterAllTransactions('all', '', '', currentSelectedMonth.toString(), 'all'), 'all-transactions-list');
                updateStatusSummary();
                renderExpenseCategories();
                renderBudgets();
                
                showNotification('Sucesso', `Transação marcada como ${newStatus === 'completed' ? 'efetivada' : 'pendente'}!`, 'success');
                
            } catch (error) {
                console.error('Erro ao alternar status da transação:', error);
                showNotification('Erro', 'Não foi possível alterar o status da transação. Por favor, tente novamente.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Editar transação
        function editTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // Preencher formulário de edição
            document.getElementById('edit-transaction-id').value = transaction.id;
            document.getElementById('edit-transaction-description').value = transaction.description;
            document.getElementById('edit-transaction-amount').value = transaction.amount;
            document.getElementById('edit-transaction-category').value = transaction.category;
            document.getElementById('edit-transaction-date').value = transaction.date;
            document.getElementById('edit-transaction-notes').value = transaction.notes || '';
            document.getElementById('edit-transaction-status').checked = transaction.status === 'completed';
            
            if (transaction.type === 'income') {
                document.getElementById('edit-type-income').checked = true;
            } else {
                document.getElementById('edit-type-expense').checked = true;
            }
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
            modal.show();
        }

        // Salvar edição de transação
        async function saveTransactionEdit(transactionData) {
            const { id, type, description, amount, category, date, notes, status } = transactionData;
            
            try {
                showLoading(true);
                
                const transactionIndex = transactions.findIndex(t => t.id === id);
                if (transactionIndex === -1) {
                    showNotification('Erro', 'Transação não encontrada.', 'danger');
                    return;
                }
                
                const statusValue = status ? 'completed' : 'pending';
                const updatedTransaction = {
                    ...transactions[transactionIndex],
                    type,
                    description,
                    amount,
                    category,
                    date,
                    notes: notes || '',
                    status: statusValue
                };
                
                // Atualizar no IndexedDB
                await updateInStore(STORES.TRANSACTIONS, updatedTransaction);
                
                // Atualizar dados em memória
                transactions[transactionIndex] = updatedTransaction;
                
                // Atualizar a interface
                updateDashboard();
                renderTransactions(filterTransactionsByMonth('all'), 'transactions-list', 5);
                renderTransactions(filterAllTransactions('all', '', '', currentSelectedMonth.toString(), 'all'), 'all-transactions-list');
                updateStatusSummary();
                renderExpenseCategories();
                renderBudgets();
                renderUpcomingBills();
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editTransactionModal'));
                if (modal) modal.hide();
                
                showNotification('Sucesso', `Transação atualizada com sucesso${statusValue === 'pending' ? ' (pendente)' : ' (efetivada)'}!`, 'success');
                
            } catch (error) {
                console.error('Erro ao atualizar transação:', error);
                showNotification('Erro', 'Não foi possível atualizar a transação. Por favor, tente novamente.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Excluir transação
        async function deleteTransaction() {
            const transactionId = currentTransactionId;
            
            try {
                showLoading(true);
                
                // Encontrar transação
                const transaction = transactions.find(t => t.id === transactionId);
                if (!transaction) {
                    showNotification('Erro', 'Transação não encontrada.', 'danger');
                    return;
                }
                
                // Remover do IndexedDB
                await removeFromStore(STORES.TRANSACTIONS, transactionId);
                
                // Atualizar dados em memória
                await loadAllData();
                
                // Atualizar a interface
                updateDashboard();
                renderTransactions(filterTransactionsByMonth('all'), 'transactions-list', 5);
                renderTransactions(filterAllTransactions('all', '', '', currentSelectedMonth.toString(), 'all'), 'all-transactions-list');
                updateStatusSummary();
                renderExpenseCategories();
                renderBudgets();
                renderUpcomingBills();
                
                showNotification('Sucesso', 'Transação excluída com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao excluir transação:', error);
                showNotification('Erro', 'Não foi possível excluir a transação. Por favor, tente novamente.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Adicionar orçamento
        async function addBudget(category, amount) {
            try {
                showLoading(true);
                
                // Verificar se já existe orçamento para esta categoria
                const existingIndex = budgets.findIndex(b => b.category === category);
                
                const budgetData = {
                    category,
                    budget: amount,
                    spent: existingIndex !== -1 ? budgets[existingIndex].spent : 0
                };
                
                // Salvar no IndexedDB
                await updateInStore(STORES.BUDGETS, budgetData);
                
                // Atualizar dados em memória
                await loadAllData();
                
                renderBudgets();
                renderExpenseCategories();
                updateDashboard();
                
                // Resetar formulário
                document.getElementById('budget-form').reset();
                
                showNotification('Sucesso', 'Orçamento salvo com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao salvar orçamento:', error);
                showNotification('Erro', 'Não foi possível salvar o orçamento. Por favor, tente novamente.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Excluir orçamento
        async function deleteBudget() {
            const category = currentBudgetCategory;
            
            try {
                showLoading(true);
                
                // Remover do IndexedDB
                await removeFromStore(STORES.BUDGETS, category);
                
                // Atualizar dados em memória
                await loadAllData();
                
                renderBudgets();
                renderExpenseCategories();
                updateDashboard();
                
                showNotification('Sucesso', 'Orçamento removido com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao remover orçamento:', error);
                showNotification('Erro', 'Não foi possível remover o orçamento. Por favor, tente novamente.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Adicionar categoria
        async function addCategory(categoryData) {
            const { name, type, color, icon } = categoryData;
            
            try {
                showLoading(true);
                
                // Verificar se já existe categoria com este nome
                const existingCategory = categories.find(c => c.name.toLowerCase() === name.toLowerCase());
                if (existingCategory) {
                    showNotification('Atenção', 'Já existe uma categoria com este nome!', 'warning');
                    return;
                }
                
                const newCategory = {
                    name,
                    type,
                    color: color || '#4361ee',
                    icon: icon || 'bi-tag'
                };
                
                // Adicionar ao IndexedDB
                await addToStore(STORES.CATEGORIES, newCategory);
                
                // Atualizar dados em memória
                await loadAllData();
                
                // Atualizar a interface
                renderCategoryOptions();
                renderCategoryLists();
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
                if (modal) modal.hide();
                
                // Resetar formulário
                document.getElementById('category-form').reset();
                document.getElementById('category-color').value = '#4361ee';
                document.getElementById('category-income').checked = true;
                
                showNotification('Sucesso', 'Categoria adicionada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao adicionar categoria:', error);
                showNotification('Erro', 'Não foi possível adicionar a categoria. Por favor, tente novamente.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Editar categoria
        function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            // Preencher formulário de edição
            document.getElementById('edit-category-id').value = category.id;
            document.getElementById('edit-category-name').value = category.name;
            document.getElementById('edit-category-color').value = category.color;
            document.getElementById('edit-category-icon').value = category.icon;
            
            if (category.type === 'income') {
                document.getElementById('edit-category-income').checked = true;
            } else {
                document.getElementById('edit-category-expense').checked = true;
            }
            
            // Atualizar preview
            document.getElementById('edit-category-preview').style.backgroundColor = category.color;
            document.getElementById('edit-category-preview').style.color = getContrastColor(category.color);
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            modal.show();
        }

        // Salvar edição de categoria
        async function saveCategoryEdit(categoryData) {
            const { id, name, type, color, icon } = categoryData;
            
            try {
                showLoading(true);
                
                // Verificar se já existe outra categoria com este nome
                const existingCategory = categories.find(c => c.id !== id && c.name.toLowerCase() === name.toLowerCase());
                if (existingCategory) {
                    showNotification('Atenção', 'Já existe uma categoria com este nome!', 'warning');
                    return;
                }
                
                const categoryIndex = categories.findIndex(c => c.id === id);
                if (categoryIndex === -1) {
                    showNotification('Erro', 'Categoria não encontrada.', 'danger');
                    return;
                }
                
                const updatedCategory = {
                    ...categories[categoryIndex],
                    name,
                    type,
                    color,
                    icon
                };
                
                // Atualizar no IndexedDB
                await updateInStore(STORES.CATEGORIES, updatedCategory);
                
                // Atualizar dados em memória
                await loadAllData();
                
                // Atualizar a interface
                renderCategoryOptions();
                renderCategoryLists();
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
                if (modal) modal.hide();
                
                showNotification('Sucesso', 'Categoria atualizada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao atualizar categoria:', error);
                showNotification('Erro', 'Não foi possível atualizar a categoria. Por favor, tente novamente.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Excluir categoria
        async function deleteCategory() {
            const categoryId = currentCategoryId;
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            try {
                showLoading(true);
                
                // Verificar se há transações usando esta categoria
                const transactionsUsingCategory = transactions.filter(t => t.category === category.name);
                if (transactionsUsingCategory.length > 0) {
                    showConfirmation(
                        'Excluir Categoria',
                        `Esta categoria está sendo usada por ${transactionsUsingCategory.length} transação(ões). Ao excluí-la, essas transações serão movidas para a categoria "Outros". Deseja continuar?`,
                        async function() {
                            await proceedWithCategoryDeletion(categoryId, category.name);
                        }
                    );
                    return;
                }
                
                await proceedWithCategoryDeletion(categoryId, category.name);
                
            } catch (error) {
                console.error('Erro ao excluir categoria:', error);
                showNotification('Erro', 'Não foi possível excluir a categoria. Por favor, tente novamente.', 'danger');
                showLoading(false);
            }
        }

        // Continuar exclusão da categoria
        async function proceedWithCategoryDeletion(categoryId, categoryName) {
            try {
                // Atualizar transações para usar a categoria "Outros"
                for (const transaction of transactions) {
                    if (transaction.category === categoryName) {
                        transaction.category = 'Outros';
                        await updateInStore(STORES.TRANSACTIONS, transaction);
                    }
                }
                
                // Atualizar orçamentos
                const budgetIndex = budgets.findIndex(b => b.category === categoryName);
                if (budgetIndex !== -1) {
                    await removeFromStore(STORES.BUDGETS, categoryName);
                }
                
                // Remover categoria
                await removeFromStore(STORES.CATEGORIES, categoryId);
                
                // Atualizar dados em memória
                await loadAllData();
                
                // Atualizar a interface
                renderCategoryOptions();
                renderCategoryLists();
                renderTransactions(filterTransactionsByMonth('all'), 'transactions-list', 5);
                renderTransactions(filterAllTransactions('all', '', '', currentSelectedMonth.toString(), 'all'), 'all-transactions-list');
                renderExpenseCategories();
                renderBudgets();
                
                showNotification('Sucesso', 'Categoria excluída com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao processar exclusão da categoria:', error);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // Função auxiliar para determinar cor de contraste
        function getContrastColor(hexcolor) {
            hexcolor = hexcolor.replace("#", "");
            const r = parseInt(hexcolor.substr(0, 2), 16);
            const g = parseInt(hexcolor.substr(2, 2), 16);
            const b = parseInt(hexcolor.substr(4, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }

        // Gerar relatório
        function generateReport(period, type) {
            // Determinar qual mês usar para o relatório
            let reportMonth = currentSelectedMonth;
            let reportYear = currentSelectedYear;
            
            if (period === 'current-month') {
                const currentDate = new Date();
                reportMonth = currentDate.getMonth();
                reportYear = currentDate.getFullYear();
            } else if (period === 'last-month') {
                reportMonth = currentSelectedMonth - 1;
                if (reportMonth < 0) {
                    reportMonth = 11;
                    reportYear--;
                }
            } else if (period === 'selected-month') {
                // Usar o mês selecionado
                reportMonth = currentSelectedMonth;
                reportYear = currentSelectedYear;
            }
            
            let labels, data;
            
            if (type === 'expenses') {
                // Agrupar despesas por categoria do mês do relatório (apenas efetivadas)
                const categoryTotals = {};
                transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    if (transaction.type === 'expense' && 
                        transaction.status === 'completed' &&
                        transactionDate.getMonth() === reportMonth && 
                        transactionDate.getFullYear() === reportYear) {
                        
                        if (!categoryTotals[transaction.category]) {
                            categoryTotals[transaction.category] = 0;
                        }
                        categoryTotals[transaction.category] += transaction.amount;
                    }
                });
                
                labels = Object.keys(categoryTotals);
                data = Object.values(categoryTotals);
                
                if (labels.length === 0) {
                    labels = ['Nenhuma despesa'];
                    data = [0];
                }
            } else if (type === 'income-vs-expenses') {
                // Calcular receitas vs despesas do mês do relatório (apenas efetivadas)
                let monthlyIncome = 0;
                let monthlyExpense = 0;
                
                transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    if (transaction.status === 'completed' &&
                        transactionDate.getMonth() === reportMonth && 
                        transactionDate.getFullYear() === reportYear) {
                        
                        if (transaction.type === 'income') {
                            monthlyIncome += transaction.amount;
                        } else {
                            monthlyExpense += transaction.amount;
                        }
                    }
                });
                
                labels = ['Receitas', 'Despesas'];
                data = [monthlyIncome, monthlyExpense];
            } else if (type === 'status') {
                // Relatório de status de efetivação
                let completedIncome = 0;
                let completedExpense = 0;
                let pendingIncome = 0;
                let pendingExpense = 0;
                
                transactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    if (transactionDate.getMonth() === reportMonth && 
                        transactionDate.getFullYear() === reportYear) {
                        
                        if (transaction.status === 'completed') {
                            if (transaction.type === 'income') {
                                completedIncome += transaction.amount;
                            } else {
                                completedExpense += transaction.amount;
                            }
                        } else {
                            if (transaction.type === 'income') {
                                pendingIncome += transaction.amount;
                            } else {
                                pendingExpense += transaction.amount;
                            }
                        }
                    }
                });
                
                labels = ['Receitas Efetivadas', 'Receitas Pendentes', 'Despesas Efetivadas', 'Despesas Pendentes'];
                data = [completedIncome, pendingIncome, completedExpense, pendingExpense];
            } else {
                // Tendência mensal (mês do relatório e 2 meses anteriores) - apenas efetivadas
                const months = [];
                const monthlyData = [];
                
                for (let i = 2; i >= 0; i--) {
                    const monthDate = new Date(reportYear, reportMonth - i, 1);
                    const monthName = monthDate.toLocaleDateString('pt-BR', { month: 'short' });
                    months.push(monthName.charAt(0).toUpperCase() + monthName.slice(1));
                    
                    // Calcular receitas do mês
                    const monthIncome = transactions.reduce((sum, transaction) => {
                        const transDate = new Date(transaction.date);
                        if (transaction.type === 'income' && 
                            transaction.status === 'completed' &&
                            transDate.getMonth() === monthDate.getMonth() && 
                            transDate.getFullYear() === monthDate.getFullYear()) {
                            return sum + transaction.amount;
                        }
                        return sum;
                    }, 0);
                    
                    monthlyData.push(monthIncome);
                }
                
                labels = months;
                data = monthlyData;
            }
            
            // Destruir gráfico anterior se existir
            if (financialChart) {
                financialChart.destroy();
            }
            
            // Criar novo gráfico
            const ctx = document.getElementById('financial-chart').getContext('2d');
            
            let chartType, backgroundColor;
            if (type === 'income-vs-expenses') {
                chartType = 'doughnut';
                backgroundColor = ['#4cc9f0', '#f72585', '#4cc9f080', '#f7258580'];
            } else if (type === 'status') {
                chartType = 'bar';
                backgroundColor = ['#4cc9f0', '#4cc9f080', '#f72585', '#f7258580'];
            } else {
                chartType = 'bar';
                backgroundColor = generateColors(labels.length);
            }
            
            financialChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: type === 'expenses' ? 'Despesas (R$)' : 
                               type === 'income-vs-expenses' ? 'Valor (R$)' : 
                               type === 'status' ? 'Valor (R$)' : 'Receitas (R$)',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: type === 'income-vs-expenses' 
                            ? ['#4cc9f0', '#f72585', '#4cc9f080', '#f7258580']
                            : type === 'status'
                            ? ['#4cc9f0', '#4cc9f080', '#f72585', '#f7258580']
                            : generateColors(labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: `${type === 'expenses' ? 'Despesas por Categoria' : 
                                  type === 'income-vs-expenses' ? 'Receitas vs Despesas' : 
                                  type === 'status' ? 'Status de Efetivação' : 'Tendência de Receitas Mensais'} - ${formatMonthYear(reportMonth, reportYear)}`
                        }
                    }
                }
            });
            
            // Atualizar resumo financeiro
            const summaryContainer = document.getElementById('financial-summary');
            
            // Calcular totais do mês do relatório
            let monthlyIncome = 0;
            let monthlyExpense = 0;
            let monthlyPendingIncome = 0;
            let monthlyPendingExpense = 0;
            let monthlyTransactions = 0;
            let completedTransactions = 0;
            let pendingTransactions = 0;
            
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                if (transactionDate.getMonth() === reportMonth && 
                    transactionDate.getFullYear() === reportYear) {
                    
                    monthlyTransactions++;
                    if (transaction.status === 'completed') {
                        completedTransactions++;
                        if (transaction.type === 'income') {
                            monthlyIncome += transaction.amount;
                        } else {
                            monthlyExpense += transaction.amount;
                        }
                    } else {
                        pendingTransactions++;
                        if (transaction.type === 'income') {
                            monthlyPendingIncome += transaction.amount;
                        } else {
                            monthlyPendingExpense += transaction.amount;
                        }
                    }
                }
            });
            
            const monthlyBalance = monthlyIncome - monthlyExpense;
            const completionRate = monthlyTransactions > 0 ? Math.round((completedTransactions / monthlyTransactions) * 100) : 0;
            
            summaryContainer.innerHTML = `
                <div class="mb-3">
                    <h6>Receitas Efetivadas</h6>
                    <p class="fs-5 text-success">${formatCurrency(monthlyIncome)}</p>
                </div>
                <div class="mb-3">
                    <h6>Receitas Pendentes</h6>
                    <p class="fs-5 text-warning">${formatCurrency(monthlyPendingIncome)}</p>
                </div>
                <div class="mb-3">
                    <h6>Despesas Efetivadas</h6>
                    <p class="fs-5 text-danger">${formatCurrency(monthlyExpense)}</p>
                </div>
                <div class="mb-3">
                    <h6>Despesas Pendentes</h6>
                    <p class="fs-5 text-warning">${formatCurrency(monthlyPendingExpense)}</p>
                </div>
                <div class="mb-3">
                    <h6>Taxa de Conclusão</h6>
                    <p class="fs-6 ${completionRate === 100 ? 'text-success' : completionRate >= 70 ? 'text-warning' : 'text-danger'}">
                        ${completionRate}% (${completedTransactions}/${monthlyTransactions})
                    </p>
                </div>
            `;
            
            // Atualizar recomendações
            const recommendationsContainer = document.getElementById('recommendations');
            let recommendationsHTML = '';
            
            // Recomendações baseadas em transações pendentes
            if (pendingTransactions > 0) {
                recommendationsHTML += `
                    <div class="alert alert-warning py-2">
                        <i class="bi bi-clock me-2"></i>
                        Você tem <strong>${pendingTransactions} transação(ões) pendente(s)</strong> totalizando ${formatCurrency(monthlyPendingIncome + monthlyPendingExpense)}.
                    </div>
                `;
            }
            
            // Analisar orçamentos para recomendações
            budgets.forEach(budget => {
                // Calcular gastos do mês do relatório para esta categoria (apenas efetivadas)
                const spentThisMonth = transactions
                    .filter(t => {
                        const transactionDate = new Date(t.date);
                        return t.type === 'expense' && 
                               t.status === 'completed' &&
                               t.category === budget.category &&
                               transactionDate.getMonth() === reportMonth &&
                               transactionDate.getFullYear() === reportYear;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const percentage = (spentThisMonth / budget.budget) * 100;
                
                if (percentage > 90 && percentage <= 100) {
                    recommendationsHTML += `
                        <div class="alert alert-warning py-2">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Você está perto de exceder o orçamento de <strong>${budget.category}</strong>.
                        </div>
                    `;
                } else if (percentage > 100) {
                    recommendationsHTML += `
                        <div class="alert alert-danger py-2">
                            <i class="bi bi-exclamation-octagon me-2"></i>
                            Você excedeu o orçamento de <strong>${budget.category}</strong> em ${formatCurrency(spentThisMonth - budget.budget)}.
                        </div>
                    `;
                }
            });
            
            if (monthlyExpense > monthlyIncome * 0.7 && monthlyIncome > 0) {
                recommendationsHTML += `
                    <div class="alert alert-info py-2">
                        <i class="bi bi-lightbulb me-2"></i>
                        Suas despesas estão altas (${((monthlyExpense / monthlyIncome) * 100).toFixed(1)}% da renda). Considere reduzir gastos.
                    </div>
                `;
            }
            
            if (completionRate === 100) {
                recommendationsHTML += `
                    <div class="alert alert-success py-2">
                        <i class="bi bi-check-circle me-2"></i>
                        Parabéns! Todas as transações deste mês estão efetivadas.
                    </div>
                `;
            }
            
            if (recommendationsHTML === '') {
                recommendationsHTML = `
                    <div class="alert alert-success py-2">
                        <i class="bi bi-check-circle me-2"></i>
                        Suas finanças deste mês estão saudáveis! Continue com o bom gerenciamento.
                    </div>
                `;
            }
            
            recommendationsContainer.innerHTML = recommendationsHTML;
            
            showNotification('Sucesso', 'Relatório gerado com sucesso!', 'success');
        }

        // Gerar cores para gráficos
        function generateColors(count) {
            const colors = ['#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#ff9e00', '#7209b7'];
            if (count <= colors.length) {
                return colors.slice(0, count);
            }
            
            // Gerar cores adicionais se necessário
            const additionalColors = [];
            for (let i = 0; i < count - colors.length; i++) {
                const hue = (i * 137.508) % 360; // Usar ângulo dourado para distribuição
                additionalColors.push(`hsl(${hue}, 70%, 65%)`);
            }
            
            return [...colors, ...additionalColors];
        }

        // Navegação entre seções
        function showSection(sectionId) {
            // Esconder todas as seções
            document.getElementById('dashboard').classList.add('d-none');
            document.getElementById('transactions').classList.add('d-none');
            document.getElementById('budget').classList.add('d-none');
            document.getElementById('categories').classList.add('d-none');
            document.getElementById('reports').classList.add('d-none');
            
            // Mostrar a seção selecionada
            document.getElementById(sectionId).classList.remove('d-none');
            
            // Atualizar navegação ativa no rodapé
            document.querySelectorAll('.bottom-nav .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId) {
                    link.classList.add('active');
                }
            });
            
            // Atualizar a seção com os dados do mês selecionado
            if (sectionId === 'dashboard') {
                updateDashboard();
                renderTransactions(filterTransactionsByMonth('all'), 'transactions-list', 5);
                renderExpenseCategories();
            } else if (sectionId === 'transactions') {
                renderTransactions(filterAllTransactions('all', '', '', currentSelectedMonth.toString(), 'all'), 'all-transactions-list');
                updateStatusSummary();
            } else if (sectionId === 'budget') {
                renderBudgets();
            } else if (sectionId === 'reports') {
                generateReport('selected-month', 'expenses');
            }
        }

        // Inicializar aplicativo
        async function initApp() {
            try {
                // Inicializar IndexedDB
                await initDatabase();
                
                // Carregar dados
                const dataLoaded = await loadAllData();
                
                if (!dataLoaded) {
                    showNotification('Erro', 'Não foi possível carregar os dados. Algumas funcionalidades podem não estar disponíveis.', 'danger');
                }
                
                // Configurar eventos de navegação no rodapé
                document.querySelectorAll('.bottom-nav .nav-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const sectionId = this.getAttribute('data-section');
                        if (sectionId) {
                            showSection(sectionId);
                        }
                    });
                });
                
                // Eventos para navegação de mês (Dashboard)
                document.getElementById('prev-month-btn').addEventListener('click', goToPreviousMonth);
                document.getElementById('next-month-btn').addEventListener('click', goToNextMonth);
                document.getElementById('go-to-current-month').addEventListener('click', goToCurrentMonth);
                
                // Eventos para navegação de mês (Transações)
                document.getElementById('prev-month-btn-transactions').addEventListener('click', goToPreviousMonth);
                document.getElementById('next-month-btn-transactions').addEventListener('click', goToNextMonth);
                document.getElementById('go-to-current-month-transactions').addEventListener('click', goToCurrentMonth);
                
                // Eventos para navegação de mês (Orçamento)
                document.getElementById('prev-month-btn-budget').addEventListener('click', goToPreviousMonth);
                document.getElementById('next-month-btn-budget').addEventListener('click', goToNextMonth);
                document.getElementById('go-to-current-month-budget').addEventListener('click', goToCurrentMonth);
                
                // Eventos para navegação de mês (Relatórios)
                document.getElementById('prev-month-btn-reports').addEventListener('click', goToPreviousMonth);
                document.getElementById('next-month-btn-reports').addEventListener('click', goToNextMonth);
                document.getElementById('go-to-current-month-reports').addEventListener('click', goToCurrentMonth);
                
                // Evento para transação recorrente
                document.getElementById('transaction-recurring').addEventListener('change', function() {
                    const recurringOptions = document.getElementById('recurring-options');
                    recurringOptions.style.display = this.checked ? 'block' : 'none';
                });
                
                // Evento para o formulário de transação
                document.getElementById('transaction-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const type = document.querySelector('input[name="transaction-type"]:checked').value;
                    const description = document.getElementById('transaction-description').value;
                    const amount = parseFloat(document.getElementById('transaction-amount').value);
                    const category = document.getElementById('transaction-category').value;
                    const date = document.getElementById('transaction-date').value;
                    const notes = document.getElementById('transaction-notes').value;
                    const recurring = document.getElementById('transaction-recurring').checked;
                    const frequency = recurring ? parseInt(document.getElementById('recurring-frequency').value) : 1;
                    const times = recurring ? parseInt(document.getElementById('recurring-times').value) : 1;
                    const status = document.getElementById('transaction-status').checked;
                    
                    if (!category) {
                        showNotification('Atenção', 'Por favor, selecione uma categoria.', 'warning');
                        return;
                    }
                    
                    addTransaction({
                        type,
                        description,
                        amount,
                        category,
                        date,
                        notes,
                        recurring,
                        frequency,
                        times,
                        status
                    });
                });
                
                // Evento para o formulário de edição de transação
                document.getElementById('edit-transaction-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const id = parseInt(document.getElementById('edit-transaction-id').value);
                    const type = document.querySelector('input[name="edit-transaction-type"]:checked').value;
                    const description = document.getElementById('edit-transaction-description').value;
                    const amount = parseFloat(document.getElementById('edit-transaction-amount').value);
                    const category = document.getElementById('edit-transaction-category').value;
                    const date = document.getElementById('edit-transaction-date').value;
                    const notes = document.getElementById('edit-transaction-notes').value;
                    const status = document.getElementById('edit-transaction-status').checked;
                    
                    if (!category) {
                        showNotification('Atenção', 'Por favor, selecione uma categoria.', 'warning');
                        return;
                    }
                    
                    saveTransactionEdit({
                        id,
                        type,
                        description,
                        amount,
                        category,
                        date,
                        notes,
                        status
                    });
                });
                
                // Evento para o formulário de orçamento
                document.getElementById('budget-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const category = document.getElementById('budget-category').value;
                    const amount = parseFloat(document.getElementById('budget-amount').value);
                    
                    if (!category) {
                        showNotification('Atenção', 'Por favor, selecione uma categoria.', 'warning');
                        return;
                    }
                    
                    if (!amount || amount <= 0) {
                        showNotification('Atenção', 'Por favor, insira um valor válido para o orçamento.', 'warning');
                        return;
                    }
                    
                    addBudget(category, amount);
                });
                
                // Evento para o formulário de categoria
                document.getElementById('category-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('category-name').value.trim();
                    const type = document.querySelector('input[name="category-type"]:checked').value;
                    const color = document.getElementById('category-color').value;
                    const icon = document.getElementById('category-icon').value;
                    
                    if (!name) {
                        showNotification('Atenção', 'Por favor, insira um nome para a categoria.', 'warning');
                        return;
                    }
                    
                    addCategory({
                        name,
                        type,
                        color,
                        icon
                    });
                });
                
                // Evento para o formulário de edição de categoria
                document.getElementById('edit-category-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const id = parseInt(document.getElementById('edit-category-id').value);
                    const name = document.getElementById('edit-category-name').value.trim();
                    const type = document.querySelector('input[name="edit-category-type"]:checked').value;
                    const color = document.getElementById('edit-category-color').value;
                    const icon = document.getElementById('edit-category-icon').value;
                    
                    if (!name) {
                        showNotification('Atenção', 'Por favor, insira um nome para a categoria.', 'warning');
                        return;
                    }
                    
                    saveCategoryEdit({
                        id,
                        name,
                        type,
                        color,
                        icon
                    });
                });
                
                // Evento para preview de cor da categoria
                document.getElementById('category-color').addEventListener('input', function() {
                    const preview = document.getElementById('category-preview');
                    preview.style.backgroundColor = this.value;
                    preview.style.color = getContrastColor(this.value);
                });
                
                // Evento para preview de cor da categoria (edição)
                document.getElementById('edit-category-color').addEventListener('input', function() {
                    const preview = document.getElementById('edit-category-preview');
                    preview.style.backgroundColor = this.value;
                    preview.style.color = getContrastColor(this.value);
                });
                
                // Evento para filtros de transações no dashboard
                document.querySelectorAll('.filter-badge').forEach(badge => {
                    badge.addEventListener('click', function() {
                        const filter = this.getAttribute('data-filter');
                        const filtered = filterTransactionsByMonth(filter);
                        renderTransactions(filtered, 'transactions-list', 5);
                        
                        // Ativar badge selecionado
                        document.querySelectorAll('.filter-badge').forEach(b => {
                            b.classList.remove('bg-primary', 'text-white');
                            b.classList.add('bg-light', 'text-dark');
                        });
                        
                        this.classList.remove('bg-light', 'text-dark');
                        this.classList.add('bg-primary', 'text-white');
                    });
                });
                
                // Evento para busca de transações na seção de transações
                document.getElementById('search-transaction').addEventListener('input', function() {
                    const search = this.value;
                    const category = document.getElementById('filter-category').value;
                    const monthFilter = document.getElementById('filter-month').value;
                    const statusFilter = document.getElementById('filter-status').value;
                    const filtered = filterAllTransactions('all', search, category, monthFilter, statusFilter);
                    renderTransactions(filtered, 'all-transactions-list');
                });
                
                // Evento para filtro de categoria na seção de transações
                document.getElementById('filter-category').addEventListener('change', function() {
                    const category = this.value;
                    const search = document.getElementById('search-transaction').value;
                    const monthFilter = document.getElementById('filter-month').value;
                    const statusFilter = document.getElementById('filter-status').value;
                    const filtered = filterAllTransactions('all', search, category, monthFilter, statusFilter);
                    renderTransactions(filtered, 'all-transactions-list');
                });
                
                // Evento para filtro de mês na seção de transações
                document.getElementById('filter-month').addEventListener('change', function() {
                    const monthFilter = this.value;
                    const search = document.getElementById('search-transaction').value;
                    const category = document.getElementById('filter-category').value;
                    const statusFilter = document.getElementById('filter-status').value;
                    const filtered = filterAllTransactions('all', search, category, monthFilter, statusFilter);
                    renderTransactions(filtered, 'all-transactions-list');
                });
                
                // Evento para filtro de status na seção de transações
                document.getElementById('filter-status').addEventListener('change', function() {
                    const statusFilter = this.value;
                    const search = document.getElementById('search-transaction').value;
                    const category = document.getElementById('filter-category').value;
                    const monthFilter = document.getElementById('filter-month').value;
                    const filtered = filterAllTransactions('all', search, category, monthFilter, statusFilter);
                    renderTransactions(filtered, 'all-transactions-list');
                });
                
                // Evento para gerar relatório
                document.getElementById('generate-report').addEventListener('click', function() {
                    const period = document.getElementById('report-period').value;
                    const type = document.getElementById('report-type').value;
                    generateReport(period, type);
                });
                
                // Evento para ver todas as transações
                document.getElementById('view-all-transactions').addEventListener('click', function() {
                    showSection('transactions');
                });
                
                // Evento para confirmação de modal
                document.getElementById('confirmationModalConfirm').addEventListener('click', function() {
                    if (confirmationCallback) {
                        confirmationCallback();
                        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
                        if (modal) modal.hide();
                    }
                });
                
                // Inicializar interface
                updateMonthDisplay();
                updateDashboard();
                renderCategoryOptions();
                renderTransactions(filterTransactionsByMonth('all'), 'transactions-list', 5);
                renderTransactions(filterAllTransactions('all', '', '', currentSelectedMonth.toString(), 'all'), 'all-transactions-list');
                updateStatusSummary();
                renderExpenseCategories();
                renderUpcomingBills();
                renderBudgets();
                renderCategoryLists();
                
                // Mostrar seção inicial
                showSection('dashboard');
                
                console.log('Aplicativo inicializado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao inicializar o aplicativo:', error);
                showNotification('Erro Crítico', 'Não foi possível inicializar o aplicativo. Por favor, recarregue a página.', 'danger');
            }
        }

        // Inicializar quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>